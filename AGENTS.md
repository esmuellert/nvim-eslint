# AGENTS.md - AI Agent Context for nvim-eslint

## Project Overview

`nvim-eslint` is a Neovim language server plugin that integrates ESLint functionality within Neovim. This plugin acts as a **bridge** between two critical components:

1. **Neovim's built-in language client** - The native LSP client implementation in Neovim
2. **[microsoft/vscode-eslint](https://github.com/microsoft/vscode-eslint)** - Microsoft VSCode's ESLint language server

### Core Architecture

The plugin enables ESLint linting in Neovim by:
- Using Neovim's native LSP client API
- Connecting to the vscode-eslint language server packaged in the `vscode-eslint` folder
- Providing optimized default configurations and settings
- Supporting complex scenarios like monorepos and ESLint flat configs

## Sources of Truth

When developing or maintaining this plugin, **always refer to these authoritative sources**:

### 1. Neovim LSP API
- **Official API Documentation**: [Neovim LSP Client API](https://neovim.io/doc/user/lsp.html)
- **Source Code**: [neovim/neovim](https://github.com/neovim/neovim)
- The plugin uses Neovim's native LSP client, so all client-side behavior must conform to Neovim's API

### 2. vscode-eslint Language Server
- **Repository**: [microsoft/vscode-eslint](https://github.com/microsoft/vscode-eslint)
- **Documentation**: Server settings, configuration options, and protocol behavior
- **Source Code**: Especially `server/src/eslint.ts` and `server/src/eslintServer.ts`
- **Client Code**: `client/src/client.ts` for understanding expected client behavior
- The language server is the final reference for all ESLint-related functionality

### 3. README.md (This Repository)
- **The specification of the plugin** - explains how it works and what configurations it supports
- Must ensure that new changes don't break existing designs documented in README.md
- Contains critical configuration examples and debugging instructions

## Key Directories

### `vscode-eslint/`
- Contains the **built vscode-eslint language server**
- Generated by running the build script in the repository root
- This is the actual language server binary that Neovim connects to
- **Do not manually edit** - rebuild using the build script if updates are needed
- Explained in detail in README.md

### `lua/`
- **Main plugin implementation**
- Implements the Neovim LSP client configuration
- Contains all settings, handlers, and utility functions
- Must follow **Neovim plugin development best practices**:
  - Use Neovim's modern Lua API
  - Proper error handling with `vim.notify`
  - Leverage `vim.fs`, `vim.lsp`, and `vim.api` modules
  - Follow community conventions for plugin structure

### `tests/`
- Contains **end-to-end tests** that run the plugin with Neovim in headless mode
- Uses real repositories to ensure the plugin functions correctly
- Tests compare nvim-eslint output with ESLint CLI output for parity

#### Testing Requirements
- **Package Manager**: Always use `pnpm` for external test repositories
- **Neovim Version**: Must be no older than the latest released version from [neovim/neovim releases](https://github.com/neovim/neovim/releases)
- **Installation**: If Neovim is not available in your environment, install it before running tests
- **CI**: Tests run in GitHub Actions using headless Neovim

## Development Guidelines

### Making Changes

1. **Understand Both Sides**
   - Changes often require understanding both Neovim LSP client behavior AND vscode-eslint server expectations
   - Check Neovim API docs for client-side changes
   - Check vscode-eslint source code for server-side behavior

2. **Configuration Changes**
   - All settings mirror vscode-eslint server parameters
   - Reference vscode-eslint settings documentation
   - Dynamic settings use Lua functions that receive buffer numbers

3. **Testing Changes**
   - Run end-to-end tests in `tests/` directory
   - Tests ensure parity between nvim-eslint and ESLint CLI
   - Follow instructions in test documentation

4. **Debugging**
   - Enable debug mode in plugin config
   - Rebuild server with debug flag for source maps
   - Use debugger configurations provided in the repository

### Neovim Plugin Best Practices

When writing Lua code for this plugin:

- **Use modern Neovim APIs**:
  - Use appropriate `vim.lsp.*` functions for LSP operations
  - Use `vim.fs.*` for filesystem operations
  - Use `vim.api.*` for Neovim API calls
  - Use `vim.notify()` for user messages

- **Handle edge cases**:
  - Monorepo structures with multiple package.json files
  - ESLint flat config files
  - Multiple workspaces and working directories
  - Cross-platform compatibility (Windows, macOS, Linux)

- **Error handling**:
  - Use `vim.notify()` with appropriate log levels
  - Provide informative error messages
  - Gracefully handle missing dependencies

- **Performance considerations**:
  - Use efficient root directory detection
  - Avoid unnecessary LSP client spawns
  - Leverage dynamic settings for buffer-specific configs

### Common Development Scenarios

#### Updating vscode-eslint Version
1. Modify the build script to checkout desired release
2. Run the build script from repository root
3. Test with end-to-end tests
4. Update README.md if new settings are available

#### Adding New Configuration Options
1. Check vscode-eslint settings documentation for available options
2. Add to default settings in the plugin implementation
3. Document in README.md Configuration section
4. Ensure backward compatibility

#### Fixing Monorepo Issues
1. Understand the repository structure
2. Review working directory and root directory settings
3. Check node path resolution
4. Debug with breakpoints in vscode-eslint server
5. Test with actual monorepo scenarios

## Important Notes

### What NOT to Change
- **vscode-eslint/** - This is built output, modify the build script instead
- **Core LSP protocol behavior** - Must match Neovim LSP expectations
- **Existing documented configurations** - Maintain backward compatibility

### External Dependencies
- **Node.js**: Required for running the language server
- **ESLint**: Must be installed in the target project
- **pnpm**: Required for test fixtures and monorepo scenarios

### Monorepo Considerations
The plugin is designed to work well with monorepos:
- Each package can have its own ESLint config
- Dynamic working directory detection
- Efficient LSP client management per workspace
- Support for both pnpm and npm workspaces

## Additional Resources

- **Project README**: Comprehensive setup and configuration guide
- **Neovim LSP Help**: `:help lsp` in Neovim
- **vscode-eslint Docs**: [GitHub Repository](https://github.com/microsoft/vscode-eslint)
- **ESLint Documentation**: [eslint.org](https://eslint.org/)
- **LSP Specification**: [Language Server Protocol](https://microsoft.github.io/language-server-protocol/)

## Quick Reference

### Key Directories
- Plugin implementation: `lua/`
- Language server: `vscode-eslint/`
- Tests: `tests/`
- Build script: repository root

### Testing Commands
```bash
# Run end-to-end parity tests
python tests/e2e/parity/run_eslint_parity_suite.py \
  --fixture-root /path/to/test-repository

# Seed test errors
python tests/e2e/parity/seed_eslint_errors.py /path/to/file.ts
```

### Build Commands
```bash
# Build language server (production)
./build-eslint-language-server.sh

# Build language server (debug mode with source maps)
./build-eslint-language-server.sh --debug
```

---

This document provides context for AI agents working on nvim-eslint. Always prioritize the sources of truth (Neovim API and vscode-eslint) when making decisions.

# AGENTS.md - AI Agent Context for nvim-eslint

## Project Overview

`nvim-eslint` is a Neovim language server plugin that integrates ESLint functionality within Neovim. This plugin acts as a **bridge** between two critical components:

1. **Neovim's built-in language client** - The native LSP client implementation in Neovim
2. **[microsoft/vscode-eslint](https://github.com/microsoft/vscode-eslint)** - Microsoft VSCode's ESLint language server

### Core Architecture

The plugin enables ESLint linting in Neovim by:
- Using Neovim's native LSP client API (`vim.lsp.start`)
- Connecting to the vscode-eslint language server (packaged in `vscode-eslint/server/out/`)
- Providing optimized default configurations and settings
- Supporting complex scenarios like monorepos and ESLint 9 flat configs

## Sources of Truth

When developing or maintaining this plugin, **always refer to these authoritative sources**:

### 1. Neovim LSP API
- **Official API Documentation**: [Neovim LSP Client API](https://neovim.io/doc/user/lsp.html)
- **Source Code**: [neovim/neovim](https://github.com/neovim/neovim)
- The plugin uses Neovim's native LSP client, so all client-side behavior must conform to Neovim's API

### 2. vscode-eslint Language Server
- **Repository**: [microsoft/vscode-eslint](https://github.com/microsoft/vscode-eslint)
- **Documentation**: Server settings, configuration options, and protocol behavior
- **Source Code**: Especially `server/src/eslint.ts` and `server/src/eslintServer.ts`
- **Client Code**: `client/src/client.ts` for understanding expected client behavior
- The language server is the final reference for all ESLint-related functionality

### 3. README.md (This Repository)
- **The specification of the plugin** - explains how it works and what configurations it supports
- Must ensure that new changes don't break existing designs documented in README.md
- Contains critical configuration examples and debugging instructions

## Key Directories and Files

### `/vscode-eslint/server/out/`
- Contains the **built vscode-eslint language server**
- Generated by running `./build-eslint-language-server.sh`
- This is the actual language server binary that Neovim connects to
- **Do not manually edit** - rebuild using the script if updates are needed

### `/build-eslint-language-server.sh`
- Script that builds the vscode-eslint language server
- Clones microsoft/vscode-eslint, checks out a specific release (currently 3.0.16)
- Builds the server using webpack
- Run with `--debug` flag to enable source maps for debugging
- Explained in detail in README.md

### `/lua/nvim-eslint/init.lua`
- **Main plugin implementation** (~220 lines)
- Implements the Neovim LSP client configuration
- Contains all settings, handlers, and utility functions
- Must follow **Neovim plugin development best practices**:
  - Use Neovim's modern Lua API
  - Proper error handling with `vim.notify`
  - Leverage `vim.fs`, `vim.lsp`, and `vim.api` modules
  - Follow community conventions for plugin structure

### `/tests/`
- Contains **end-to-end tests** that run the plugin with Neovim in headless mode
- Uses real repositories (turborepo) to ensure the plugin functions correctly
- Tests compare nvim-eslint output with ESLint CLI output for parity

#### Testing Requirements
- **Package Manager**: Always use `pnpm` for external test repositories
- **Neovim Version**: Must be no older than the latest released version from [neovim/neovim releases](https://github.com/neovim/neovim/releases)
- **Installation**: If Neovim is not available in your environment, install it before running tests
- **CI**: Tests run in GitHub Actions using headless Neovim

## Development Guidelines

### Making Changes

1. **Understand Both Sides**
   - Changes often require understanding both Neovim LSP client behavior AND vscode-eslint server expectations
   - Check Neovim API docs for client-side changes
   - Check vscode-eslint source code for server-side behavior

2. **Configuration Changes**
   - All settings mirror vscode-eslint server parameters
   - Reference: [vscode-eslint settings.ts](https://github.com/microsoft/vscode-eslint/blob/main/%24shared/settings.ts)
   - Dynamic settings use Lua functions: `function(bufnr) ... end`

3. **Testing Changes**
   - Run end-to-end tests in `tests/e2e/parity/`
   - Tests ensure parity between nvim-eslint and ESLint CLI
   - Follow instructions in `tests/e2e/parity/README.md`

4. **Debugging**
   - Enable debug mode: `debug = true` in plugin config
   - Rebuild server with debug: `./build-eslint-language-server.sh --debug`
   - Use VSCode debugger (`.vscode/launch.json` provided)
   - Common breakpoints:
     - Configuration reception: `vscode-eslint/server/src/eslint.ts:923`
     - ESLint path resolution: `vscode-eslint/server/src/eslint.ts:914`

### Neovim Plugin Best Practices

When writing Lua code for this plugin:

- **Use modern Neovim APIs**:
  - `vim.lsp.start()` for starting LSP clients
  - `vim.fs.root()` for finding project roots
  - `vim.api.nvim_create_autocmd()` for autocommands
  - `vim.notify()` for user messages

- **Handle edge cases**:
  - Monorepo structures with multiple package.json files
  - ESLint flat config files (eslint.config.js)
  - Multiple workspaces and working directories
  - Cross-platform compatibility (Windows, macOS, Linux)

- **Error handling**:
  - Use `vim.notify()` with appropriate log levels
  - Provide informative error messages
  - Gracefully handle missing dependencies

- **Performance considerations**:
  - Use efficient root directory detection
  - Avoid unnecessary LSP client spawns
  - Leverage dynamic settings for buffer-specific configs

### Common Development Scenarios

#### Updating vscode-eslint Version
1. Modify `build-eslint-language-server.sh` to checkout desired release
2. Run the build script: `./build-eslint-language-server.sh`
3. Test with end-to-end tests
4. Update README.md if new settings are available

#### Adding New Configuration Options
1. Check vscode-eslint settings.ts for available options
2. Add to default settings in `M.make_settings()` in init.lua
3. Document in README.md Configuration section
4. Ensure backward compatibility

#### Fixing Monorepo Issues
1. Understand the repository structure
2. Review `workingDirectory` and `root_dir` settings
3. Check `nodePath` resolution
4. Debug with breakpoints in vscode-eslint server
5. Test with actual monorepo (turborepo tests)

## Important Notes

### What NOT to Change
- **vscode-eslint/server/out/** - This is built output, modify the build script instead
- **Core LSP protocol behavior** - Must match Neovim LSP expectations
- **Existing documented configurations** - Maintain backward compatibility

### External Dependencies
- **Node.js**: Required for running the language server
- **ESLint**: Must be installed in the target project
- **pnpm**: Required for test fixtures and monorepo scenarios

### Monorepo Considerations
The plugin is designed to work well with monorepos:
- Each package can have its own ESLint config
- Dynamic working directory detection
- Efficient LSP client management per workspace
- Support for both pnpm and npm workspaces

## Additional Resources

- **Project README**: Comprehensive setup and configuration guide
- **Neovim LSP Help**: `:help lsp` in Neovim
- **vscode-eslint Docs**: [GitHub Repository](https://github.com/microsoft/vscode-eslint)
- **ESLint Documentation**: [eslint.org](https://eslint.org/)
- **LSP Specification**: [Language Server Protocol](https://microsoft.github.io/language-server-protocol/)

## Quick Reference

### File Locations
- Plugin entry point: `lua/nvim-eslint/init.lua`
- Language server: `vscode-eslint/server/out/eslintServer.js`
- Tests: `tests/e2e/parity/`
- Build script: `build-eslint-language-server.sh`

### Key Functions
- `M.setup(user_config)` - Main plugin setup function
- `M.make_settings(buffer)` - Generate LSP settings
- `M.resolve_git_dir(bufnr)` - Find git root
- `M.resolve_package_json_dir(bufnr)` - Find package.json directory
- `M.use_flat_config(bufnr)` - Detect ESLint flat config

### Testing Commands
```bash
# Run end-to-end parity tests
python tests/e2e/parity/run_eslint_parity_suite.py \
  --fixture-root /path/to/turborepo

# Seed test errors
python tests/e2e/parity/seed_eslint_errors.py /path/to/file.ts
```

### Build Commands
```bash
# Build language server (production)
./build-eslint-language-server.sh

# Build language server (debug mode with source maps)
./build-eslint-language-server.sh --debug
```

---

This document provides context for AI agents working on nvim-eslint. Always prioritize the sources of truth (Neovim API and vscode-eslint) when making decisions.
